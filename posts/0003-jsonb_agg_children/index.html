<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Mykola on blog | Postgres jsonb_agg children cart</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.81.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link href=/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css rel=stylesheet><link rel=stylesheet href=/css/custom.css><meta property="og:title" content="Postgres jsonb_agg children cart"><meta property="og:description" content="Selecting lists of related entities from RDBMS&rsquo;es can be a chore at times. Especially when ORM&rsquo;s aren&rsquo;t used or desired. jsonb_agg of postgres can be a convenient workaround for these cases:"><meta property="og:type" content="article"><meta property="og:url" content="https://mgurov.github.io/posts/0003-jsonb_agg_children/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-31T16:57:33+02:00"><meta property="article:modified_time" content="2019-07-31T16:57:33+02:00"><meta itemprop=name content="Postgres jsonb_agg children cart"><meta itemprop=description content="Selecting lists of related entities from RDBMS&rsquo;es can be a chore at times. Especially when ORM&rsquo;s aren&rsquo;t used or desired. jsonb_agg of postgres can be a convenient workaround for these cases:"><meta itemprop=datePublished content="2019-07-31T16:57:33+02:00"><meta itemprop=dateModified content="2019-07-31T16:57:33+02:00"><meta itemprop=wordCount content="289"><meta itemprop=keywords content="postgres,jsonb,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Postgres jsonb_agg children cart"><meta name=twitter:description content="Selecting lists of related entities from RDBMS&rsquo;es can be a chore at times. Especially when ORM&rsquo;s aren&rsquo;t used or desired. jsonb_agg of postgres can be a convenient workaround for these cases:"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=https://mgurov.github.io/ class="f3 fw2 hover-white no-underline white-90 dib">Mykola on blog</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="posts page">posts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="about me page">about me</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/talks/ title="talks page">talks</a></li></ul><a href=https://nl.linkedin.com/in/mgurov target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><p class="f6 b helvetica tracked">POSTS</p><h1 class="f1 athelas mb1">Postgres jsonb_agg children cart</h1><time class="f6 mv4 dib tracked" datetime=2019-07-31T16:57:33+02:00>July 31, 2019</time></header><section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Selecting lists of related entities from RDBMS&rsquo;es can be a chore at times. Especially when ORM&rsquo;s aren&rsquo;t used or desired. jsonb_agg of postgres can be a convenient workaround for these cases:</p><pre class="hackprecolor2 b--black-10 ba">
select orders.*,
    (select jsonb_agg(joined_lines) from
      (select * 
        from lines 
        where lines.order_id = orders.order_id
      ) joined_lines
    ) as lines
from orders
where ...
;
</pre><p>Given we have a vanilla order management system with orders and their lines in separate tables:</p><table class="collapse ba br2 b--black-10"><tbody><tr class="striped--light-gray ph3"><td class="ph3 tc" colspan=3>orders</td></tr><tr class="striped--light-gray ph3"><td class="ph3 tr">id</td><td class="ph3 tr">customer_id</td><td class="ph3 tr">total_value</td></tr><tr class=striped--light-gray><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">15</td></tr><tr class=striped--light-gray><td class="ph3 tr">2</td><td class="ph3 tr">2</td><td class="ph3 tr">10</td></tr></tbody></table><p><table class="collapse ba br2 b--black-10"><tbody><tr class="striped--light-gray ph3"><td class="ph3 tc" colspan=4>lines</td></tr><tr class="striped--light-gray ph3"><td class="ph3 tr">line_id</td><td class="ph3 tr">order_id</td><td class="ph3 tr">value</td></tr><tr class=striped--light-gray><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">10</td></tr><tr class=striped--light-gray><td class="ph3 tr">2</td><td class="ph3 tr">1</td><td class="ph3 tr">2</td></tr><tr class=striped--light-gray><td class="ph3 tr">3</td><td class="ph3 tr">1</td><td class="ph3 tr">3</td></tr><tr class=striped--light-gray><td class="ph3 tr">4</td><td class="ph3 tr">2</td><td class="ph3 tr">10</td></tr></tbody></table></p><p>The query above would return a nice representation:</p><table class="collapse ba br2 b--black-10"><tbody><tr class="striped--light-gray ph3"><td class=ph3>order_id</td><td class=ph3>customer_id</td><td class=ph3>total_value</td><td class=ph3>lines (pretty-formated)</td></tr><tr class=striped--light-gray><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">15</td><td class="ph3 hackprecolor"><pre>
[
  {"value": 10, "line_id": 1, "order_id": 1}, 
  {"value": 2, "line_id": 2, "order_id": 1}, 
  {"value": 3, "line_id": 3, "order_id": 1}
]</pre></td></tr><tr class=striped--light-gray><td class="ph3 tr">2</td><td class="ph3 tr">2</td><td class="ph3 tr">10</td><td class="ph3 hackprecolor"><pre>[{"value": 10, "line_id": 4, "order_id": 2}]</pre></td></tr></tbody></table><p>Which we can conveniently process in our application code.</p><p><em>Warning</em>: I am not a query optimization expert, so please examine your execution plan carefully before applying the technique. I saw minor deviations in costs for my production queries, but your mileage can differ.</p><h2 id=alternative-a-simple-join>Alternative: a simple join</h2><p>A common way to eagerly select multiple orders with their lines would be to do a join:</p><pre class="hackprecolor2 b--black-10 ba">
SELECT * 
  from orders 
       inner join lines on orders.id = lines.order_id
  WHERE ...
</pre><p>This query would produce dataset along the lines of:</p><table class="collapse ba br2 b--black-10"><tbody><tr class="striped--light-gray ph3"><td class="ph3 tr">order_id</td><td class="ph3 tr">customer_id</td><td class="ph3 tr">total_value</td><td class="ph3 tr">line_id</td><td class="ph3 tr">order_id</td><td class="ph3 tr">value</td></tr><tr class=striped--light-gray><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">15</td><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">10</td></tr><tr class=striped--light-gray><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">15</td><td class="ph3 tr">2</td><td class="ph3 tr">1</td><td class="ph3 tr">2</td></tr><tr class=striped--light-gray><td class="ph3 tr">1</td><td class="ph3 tr">1</td><td class="ph3 tr">15</td><td class="ph3 tr">2</td><td class="ph3 tr">1</td><td class="ph3 tr">3</td></tr><tr class=striped--light-gray><td class="ph3 tr">2</td><td class="ph3 tr">2</td><td class="ph3 tr">10</td><td class="ph3 tr">4</td><td class="ph3 tr">2</td><td class="ph3 tr">10</td></tr></tbody></table><p>Mapping onto the <code>order - lines</code> structure at the receiving side isn&rsquo;t too complex, but can become a burden with the number of relations joined increasing.</p><h3 id=see-also>See also</h3><p><a href=https://stackoverflow.com/questions/40652871/postgresql-jsonb-agg-subquery-sort>On sorting within jsonb_agg</a></p><ul class=pa0><li class=list><a href=/tags/postgres class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">postgres</a></li><li class=list><a href=/tags/jsonb class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">jsonb</a></li></ul><div class=mt6></div></section><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://mgurov.github.io/>&copy; Mykola on blog 2023</a><div><a href=https://nl.linkedin.com/in/mgurov target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer><script src=/dist/js/app.3fc0f988d21662902933.js></script></body></html>